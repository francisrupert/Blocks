!function(a,b,c){"use strict";var d=function(b,c){this.$el=a(b),this.config=null,this.components=[],this.component_variations={},this.cache={},this.loadConfig(c),this.logging=!0,this._setupLogging(),this.init()},e=function(a){this.config=a.parent.config,this.parent=a.parent,this.page=a.page,this.init(a.component)};e.prototype={init:function(b){var c=this;c.$el=b,c.name=b.attr("data-component"),c.source=b.attr("data-source"),c.setComponentPath(b),c.setVariationName(b),c.setTemplateData(b),c.setWrappingMarkup(b),c.is_nested=void 0===c.parent.type||"component"===c.parent.type,c.has_nested=!1,c.classes=[],c.classes.push(b.attr("class")),c.attributes={},c.children={},c.child_classes={},c.child_attributes={},c.setRenderingConfig(),c.child_count=0,c.children_loaded=0,c.children_rendered=0,c.no_children=!1,a.when(c.fetch()).then(function(a){c.parse(a).done(function(){c.parent.childDoneLoading(c)})})},addTemplate:function(a){var b,c=this,d=a.html();void 0!==d&&d.length>0?(b=d.trim().replace(/\n\s*/g,""),c.template||(c.template=Handlebars.compile(b),window.debug.debug("Added fetched template: "+c.template_name()))):(window.debug.error("FAILED TO FIND VARIATION: "+c.variation_name+" in "+c.name),window.alert("FAILED TO FIND VARIATION: "+c.variation_name+" in "+c.name))},childDoneLoading:function(a){var b=this;window.debug.debug("CHILD LOADED: "+a.template_name()),b.children_loaded++,b.children[a.template_name()]=a,b.child_count===b.children_loaded&&void 0!==b.parent&&b.parent.childDoneLoading(b)},template_uri:function(){return this.component_path+this.name+".html"},css_uri:function(){return this.component_path+"css/"+this.name+".css"},js_uri:function(){return this.component_path+"js/"+this.name+".js"},setVariationName:function(a){var b=a.attr("data-variation"),c=this.constructVariationName(b);this.variation_name=c,this.sanitized_variation_name=this.sanitizeVariationName(c)},template_name:function(){return[this.name,this.sanitized_variation_name].join("_")},constructVariationName:function(a){return void 0!==a?a:"default"},sanitizeVariationName:function(a){return a.replace(/-/g,"_")},getTemplateNameFromVariation:function(a){var b=this,c=a.attr("data-variation"),d=b.constructVariationName(c);return d=b.sanitizeVariationName(d),[a.attr("data-component"),d].join("_")},updateImgSrcPath:function(){var b,c=this;c.$variation.find("img").each(function(c,d){b=a(d).attr("src"),null===b.match(/^http/)&&a(d).attr("src","library/"+b)})},fetch:function(){var b,c=this,d=c.template_uri(),e={type:"GET",url:d,dataType:"html",cache:!1,timeout:15e3};return b=c.page.cache[c.name],void 0===b&&(b=a.ajax(e),c.page.cache[c.name]=b,window.debug.debug("Queued component template: "+c.name),c.injectCSS()),b.done(function(a){void 0!==a&&""!==a&&(c.fetched_data=a,c.page.components[c.name]=c,window.debug.debug("Returned component template: "+c.name))}),b.fail(function(){window.debug.error("FAILED TO FETCH TEMPLATE: "+c.name),window.alert("FAILED TO FETCH TEMPLATE: "+c.name)}),b},parse:function(b){var c,d,f,g,h=this,i=[];return h.parse_deferred=new a.Deferred,window.debug.debug("PARSING "+h.template_uri()),b="<div>"+b+"</div>",c=a(a(b).children("#variations")),d=a(a(b).children("header")),h.$header=d,f=a(a(b).children("#documentation")),h.$documentation=f,h.classes.push(d.attr("class")),h.$variation=c.find('[data-variation="'+h.variation_name+'"]').not("[data-component]"),h.classes.push(h.$variation.attr("class")),_.each(h.$variation.prop("attributes"),function(a){return"class"===a.name?!0:void(h.attributes[a.name]=a.value)}),h.is_nested&&(h.parent.child_classes[h.template_name()]=h.classes,h.parent.child_attributes[h.template_name()]=h.attributes),"library"===h.source&&h.updateImgSrcPath(),h.addTemplate(h.$variation),g=h.$variation.find("*[data-component]"),void 0!==g&&g.length>0?g.each(function(b,c){var d=a(c);window.debug.debug("FOUND nested component: "+d.attr("data-component")),h.child_count++,i.push({parent:h,component:d})}):(h.no_children=!0,h.parse_deferred.resolve()),h.child_count>0&&(window.debug.debug("TMPL "+h.template_name()+" has "+h.child_count+" children"),_.each(i,function(a){var b;b=new e({parent:a.parent,component:a.component,page:a.parent.page})})),h.parse_deferred},render:function(){var a=this;a.no_children===!0||a.children_rendered===a.children_loaded?(a.renderTemplate(),a.parent&&a.parent.childDoneRendering(a)):_.each(a.children,function(a){a.render()})},childDoneRendering:function(b){var c=this;c.children_rendered++,c.child_count===c.children_rendered&&(c.renderTemplate(),window.debug.debug("CHILD RENDERED: "+b.template_name()),c.$el.find("[data-component]").each(function(b,d){var e=a(d),f=c.getTemplateNameFromVariation(e),g=c.children[f];a(d).replaceWith(g.$el)}),c.parent.childDoneRendering(c))},renderTemplate:function(){var b=this,c=b.template(b.template_data),d=function(){b.$el.prepend(b.comment_start),b.$el.append(b.comment_end)},e=function(){var a=b.documentationFrame(),c=b.$el.clone();void 0!==a&&(a.find("*").contents().filter(function(){return 8===this.nodeType}).replaceWith(c),b.$el.replaceWith(a.children()))};b.replace_reference===!0?(void 0!==b.enclose&&b.enclose.length>0?(b.$el=b.enclose,0===b.$el.children().length?b.$el.append(c):b.$el.children().last().append(c)):b.$el=a(c),d()):void 0!==b.enclose&&b.enclose.length>0?(b.$el=b.enclose,0===b.$el.children().length?(b.$el.append(c),b.$el.attr("class",_.uniq(_.compact(b.classes)).join(" ")),_.each(b.attributes,function(a,c){b.$el.attr(c,a)})):b.$el.children().last().append(c)):(b.$el.append(c),b.$el.attr("class",_.uniq(_.compact(b.classes)).join(" ")),_.each(b.attributes,function(a,c){b.$el.attr(c,a)})),b.hasDocumentation()&&b.hasDocumentationFrame()&&(e(),b.frame_with_documentation=!0)},injectCSS:function(){var b,c=this,d=c.css_uri(),e=a("head"),f={type:"HEAD",url:d,dataType:"html",cache:!1};b=a.ajax(f),b.done(function(){b.getResponseHeader("Content-Length")>0||b.responseText.length>0||"gzip"===b.getResponseHeader("Content-Encoding")?e.append('<link rel="stylesheet" href="'+d+'" />'):window.debug.warn("CSS resource is empty: "+d)}),b.fail(function(){window.debug.debug("CSS resource is missing: "+d)})},injectJS:function(b){var d=this,e=d.js_uri(),f=d.template_name(),g=function(){window.debug.debug("Triggering "+f),a(c).trigger(f),b.childDoneInjectingJS()};a.getScript(e).done(function(){window.debug.debug("Injected "+e),g()}).fail(function(){window.debug.debug("No JS file found at "+e),g()})},setComponentPath:function(){var a=this,b=a.source,c="components/";void 0!==b&&b.length>0?c=b:void 0!==a.config.components?void 0!==a.config.components.source&&(c=a.config.components.source):window.debug.error("Could not determine path to components."),void 0!==a.parent&&"page"!==a.parent.type&&"library"===a.parent.source&&(c="library"),"library"===c&&(a.source=c,c="library/components/"),a.component_path=c},documentationFrame:function(){var a,b=this,c=b.$el.attr("data-frame-variation");return b.hasDocumentation()&&b.hasDocumentationFrame()&&(a=b.$documentation.find('*[data-variation="'+c+'"]'),void 0!==c&&void 0!==a&&c.length>0&&a.length>0)?a:void 0},hasDocumentationFrame:function(){var a=this,b=a.$el.attr("data-frame-variation");return void 0!==b&&b.length>0},hasDocumentation:function(){var a=this;return void 0!==a.$documentation&&a.$documentation.length>0},setRenderingConfig:function(){var a=this;void 0!==a.config.components&&""!==a.config.components&&a.config.components.replace_reference===!0&&(a.replace_reference=!0),void 0!==a.$el.attr("data-place")&&("replace"===a.$el.attr("data-place")?a.replace_reference=!0:"inner"===a.$el.attr("data-place")&&(a.replace_reference=!1)),a.replace_reference===!0&&(a.comment_start='<!-- #block data-component="'+a.name+' data-variation="'+a.variation_name+'" -->',a.comment_end='<!-- /block data-component="'+a.name+' data-variation="'+a.variation_name+'" -->')},setTemplateData:function(a){var b,c=this,d=a.attr("data-content"),e=function(a,b){for(var c,d=b,e=!1,f=a.split("."),g=function(a,b){return a.hasOwnProperty(b)},h=0;h<f.length&&(c=f[h],g(d,c));h++)d=d[c],h===f.length-1&&(e=d);return e};void 0!==c.config.template_data&&""!==c.config.template_data&&void 0!==d&&(b=e(d,c.config.template_data)),c.template_data=b},setWrappingMarkup:function(b){var c=this,d=b.attr("data-enclose"),e=[],f=[];void 0!==d&&d.length>0&&(e=d.split(">"),_.each(e,function(b){var c,d,e,g,h=b.split(/[\.#\[]/),i=[],j=[];c=h[0],void 0!==c&&c.length>0&&(g=window.document.createElement(c)),b=b.replace(h[0],""),d=b.match(/(#\w+)[^\[\.]/),null!==d&&(d=d[0]),void 0!==g&&""!==g&&null!==d&&(a(g).attr("id",d.replace("#","")),b=b.replace(d,"")),e=b.split("."),_.each(e,function(a){var b=a.match(/^\[([a-z-]+=\w+)\]/);null!==b?i.push(b[1]):j.push(a)}),void 0!==g&&""!==g&&(_.isEmpty(j)||a(g).attr("class",_.compact(j).join(" ")),_.isEmpty(i)||_.each(i,function(b){a(g).attr(b.split("=")[0],b.split("=")[1])}),f.push(a(g)))}),c.enclose=_.reduce(f,function(a,b){return void 0!==a?a.append(b):a=b},void 0))},tmplError:function(a,b,c){window.debug.error("TypeError"===a.name&&"Cannot call method 'indexOf' of undefined"==a.message?"FAILED to find variation "+b+" in "+c:"FAILED to render template: "+b+" NAME: "+a.name+" MSG: "+a.message)}},d.prototype={constructor:d,loadConfig:function(b){var c=this,d=b.config_path+"config.json",e={type:"GET",dataType:"json",async:!1,cache:!1,url:d,timeout:3e4,success:function(d){c.config=a.extend(b,d)},error:function(a){window.console.error("FAILED TO FETCH CONFIG: "+d+" returned "+JSON.stringify(a)),c.config=b}};a.ajax(e)},init:function(){var b=this,d=b.$el,f=[];b.name=a(c).find("head title").text(),b.components={},b.child_count=0,b.children_loaded=0,b.children_rendered=0,b.child_count_js=0,b.child_js_injected=0,b.type="page",d.find("*[data-component]").each(function(){b.child_count++,f.push({page:b,component:a(this)})}),window.debug.debug("PAGE "+b.name+" has "+b.child_count+" children"),_.each(f,function(a){var b;b=new e({page:a.page,parent:a.page,component:a.component})}),b.config.backward_compatible===!0&&b._makeBackwardCompatible()},childDoneInjectingJS:function(){var b=this;b.child_js_injected++,b.child_count_js===b.child_js_injected&&(window.self!==window.top?(window.debug.debug("TRIGGERING blocks-done on parent body from within iFrame"),parent.$("body").trigger("blocks-done"),parent.$("body").trigger("blocks-done-inside-viewer",{iframe_id:window.frameElement.id})):(window.debug.debug("TRIGGERING blocks-done"),a(c).trigger("blocks-done")))},childDoneLoading:function(a){var b=this;b.children_loaded++,window.debug.debug("READY TO RENDER PAGE LEVEL CHILDREN: "+a.template_name()),a.render()},childDoneRendering:function(a){var b=this,c=b.$el,d=c.find('[data-component="'+a.name+'"][data-variation="'+a.variation_name+'"]');b.children_rendered++,window.debug.debug("READY TO RENDER PAGE LEVEL Component: "+a.template_name()),a.replace_reference||a.frame_with_documentation?d.replaceWith(a.$el):d.append(a.$el),b.child_count===b.children_rendered&&b.injectComponentJS(),b.component_variations[a.template_name()]=a},injectComponentJS:function(){var a=this;_.each(a.components,function(b){b.injectJS(a),a.child_count_js++})},_makeBackwardCompatible:function(){var a=this;a._wrapPage()},_setupLogging:function(){var a,b=this,c=void 0!==b.config.logging?b.config.logging:b.logging,d=["error","warn","info","debug","log"];window.debug={},void 0===typeof window.console&&(window.console={}),a=window.console,_.each(d,function(b){window.debug[b]=function(){c===!0&&a[b].apply(a,arguments)}})},_wrapPage:function(){var b,c=a("body"),d=a(".viewport");d.wrapAll('<article class="page active currentpage" />'),b=c.find(".page.active"),b.wrapAll('<section class="pages active" />')}};var f=a.fn.BlocksLoader;a.fn.BlocksLoader=function(b){return this.each(function(){var c=a(this),e=c.data("BlocksLoader"),f=a.extend({},a.fn.BlocksLoader.defaults,c.data(),"object"==typeof b&&b);e||c.data("BlocksLoader",e=new d(this,f)),"string"==typeof b&&e[b]()})},a.fn.BlocksLoader.defaults={backward_compatible:!0,config_path:"",components:{source:"components/"}},a.fn.BlocksLoader.Constructor=d,a.fn.BlocksLoader.noConflict=function(){return a.fn.BlocksLoader=f,this},a(window).on("load",function(){a("body").BlocksLoader()})}(window.jQuery,window.debug,document);